jQuery(document).ready(function($) {

    // --- ?????? ????? PDF (???? ?? ????) ---
    $('#ps_pdf_upload_button').click(function(e) {
        e.preventDefault();
        var custom_uploader = wp.media({
            title: '?????? ???? PDF',
            library: { type: 'application/pdf' },
            button: { text: '?????? ????' },
            multiple: false
        });
        custom_uploader.on('select', function() {
            var attachment = custom_uploader.state().get('selection').first().toJSON();
            $('#ps_pdf_url').val(attachment.url);
        });
        custom_uploader.open();
    });

    // --- ?????? ????? ????? ?????? (?? ????) ---
    $('#ps_gallery_upload_button').click(function(e) {
        e.preventDefault();
        var gallery_uploader = wp.media({
            title: '?????? ????? ??????',
            library: { type: 'image' },
            button: { text: '?????? ??????' },
            multiple: true // ????? ?????? ??? ???
        });

        gallery_uploader.on('select', function() {
            var selection = gallery_uploader.state().get('selection');
            var ids = selection.map(function(attachment) { return attachment.id; });
            var previewContainer = $('#ps-gallery-preview');
            
            // ???? ???? ????????? ????
            previewContainer.empty();

            // ??????????? ???? ???? ?? ????????? ????
            $('#ps_gallery_ids').val(ids.join(','));

            // ????? ????????? ?????? ????
            ids.forEach(function(id) {
                var thumb_src = wp.media.attachment(id).get('sizes').thumbnail.url;
                previewContainer.append(
                    '<div class="ps-gallery-thumb" data-id="' + id + '"><img src="' + thumb_src + '" /><span class="ps-gallery-remove">&times;</span></div>'
                );
            });
        });

        gallery_uploader.open();
    });

    // --- ??? ????? ?? ????????? ????? ---
    $(document.body).on('click', '.ps-gallery-remove', function() {
        var $thumb = $(this).parent();
        var idToRemove = $thumb.data('id');
        var currentIds = $('#ps_gallery_ids').val().split(',');
        
        // ??? ????? ?? ?????
        var newIds = currentIds.filter(function(id) { return id != idToRemove; });
        
        // ??????????? ???? ????
        $('#ps_gallery_ids').val(newIds.join(','));
        
        // ??? ????? ?? ?????????
        $thumb.remove();
    });
});